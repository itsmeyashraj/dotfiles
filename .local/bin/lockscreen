#!/bin/env bash

wallpaper=$2
cachepath=$HOME/.cache/lockscreen

width=$(xrandr --query | grep ' connected' | grep -o '[0-9][0-9]*x[0-9][0-9]*[^ ]*' | sed -r 's/^[^0-9]*([0-9]+x[0-9]+).*$/\1/' |cut -d "x" -f 1 |head -n1)
height=$(xrandr --query | grep ' connected' | grep -o '[0-9][0-9]*x[0-9][0-9]*[^ ]*' | sed -r 's/^[^0-9]*([0-9]+x[0-9]+).*$/\1/' |cut -d "x" -f 2 |head -n1)
half_width=$((width/2))
half_height=$((height/2))


fg_color=E6CB9D
wrong_color=FB4934
highlight_color=98971a
highlight_color2=83A598
verif_color=8EC07C

cropbg() {
	convert "$wallpaper" -resize ${width}x -gravity center -crop ${width}x${height}+0+0 +repage \( \
        -size 120x140 xc:none \
        \) -gravity south -compose over -composite $cachepath/resize.png
}

blurbg() {
	convert "$cachepath/resize.png" \
		-filter Gaussian \
		-blur 0x10 \
		"$cachepath/resize-blur.png"
}

genbg() {
	echo "Caching image ..."
	if [[ ! -d $HOME/.cache/lockscreen ]]; then
		mkdir $HOME/.cache/lockscreen
	fi
	cropbg
	blurbg
	echo "Finished caching image"
}

lock() {
    i3lock -n --force-clock -c 00000000 -i $cachepath/resize-blur.png \
    --insidever-color=$fg_color --insidewrong-color=$wrong_color --inside-color=fefefe00 \
    --ringver-color=$verif_color --ringwrong-color=$wrong_color --ring-color=$highlight_color \
    --keyhl-color=$fg_color --bshl-color=$fg_color --separator-color=00000000 \
    --date-color=$highlight_color --time-color=$fg_color --greeter-color=$fg_color \
    --clock \
    --indicator \
    --time-str="%H:%M:%S" \
    --date-str="%a, %m %Y" \
    --verif-text=""  --wrong-text="" --noinput-text="" \
    --time-font="FiraCode" \
    --date-font="FiraCode" --verif-font="FiraCode Nerd Font" --wrong-font="FiraCode" \
    --greeter-font="FiraCode:style=Bold"
    sleep 1
}

show_help(){
	cat <<-EOF
	Usage :
	 nordlockscreen [OPTION]

	Avaible options:
	 -i, --image             Generate cache image
	 -h, --help              Show this help

	EOF
}

case $1 in
	-i|--image)
		genbg $2 ;;
	-h|--help)
		show_help ;;
	*)
		lock ;;
esac
